# WebSocket 实时仪表盘功能需求文档 (PRD)

**项目名称**: Yu Jian Presence - WebSocket 实时数据推送系统
**版本**: 1.0
**日期**: 2026-02-03
**状态**: Sprint 1 - 需求分析阶段
**作者**: 产品经理
**目标用户**: 数字生命进化座舱运营团队

---

## 1. 项目概述

### 1.1 背景与痛点分析

当前 lab.yujian.team 网站采用传统的 REST API 轮询机制来获取系统状态数据，存在以下核心痛点：

| 痛点类别 | 具体问题 | 影响程度 |
|---------|---------|---------|
| **数据延迟** | 轮询间隔通常为 5-30 秒，无法即时反映系统状态变化 | 🔴 高 |
| **资源浪费** | 高频轮询产生大量无效请求，增加服务器负载 | 🔴 高 |
| **用户体验** | 页面需要手动刷新才能看到最新数据，操作繁琐 | 🟡 中 |
| **实时性差** | 关键事件（系统告警、状态变更）无法即时推送 | 🔴 高 |
| **连接开销** | 每次请求都需要建立/断开 TCP 连接，网络开销大 | 🟡 中 |

### 1.2 项目目标

通过引入 WebSocket 实时通信协议，实现：

1. **即时数据推送**: 服务端主动向客户端推送数据变化，延迟 < 100ms
2. **降低资源消耗**: 相比轮询，减少 80% 以上的无效网络请求
3. **提升用户体验**: 数据自动更新，无需手动刷新页面
4. **支持双向通信**: 为未来远程控制功能奠定基础

### 1.3 范围定义

**包含范围**:
- WebSocket 服务器搭建（Elysia + Bun）
- 现有 API 的实时化改造 (/status, /history, /stats, /system/health)
- React 前端 WebSocket 客户端集成
- 连接管理与心跳机制

**不包含范围**（未来迭代）:
- 消息持久化与历史回放
- 多房间/频道隔离
- 端到端加密
- 移动端原生应用适配

---

## 2. 功能需求清单（按优先级排序）

### P0 - 核心功能（必须实现）

| ID | 功能名称 | 描述 | 优先级 | 预估工期 |
|----|---------|------|-------|---------|
| WS-001 | WebSocket 基础连接 | 建立稳定的 WebSocket 连接，支持连接/断开/重连 | P0 | 2天 |
| WS-002 | 实时状态推送 | /status 接口数据实时推送（系统在线状态、负载等） | P0 | 2天 |
| WS-003 | 心跳保活机制 | 客户端与服务器定期心跳检测，自动处理断线重连 | P0 | 1天 |

### P1 - 重要功能（强烈建议）

| ID | 功能名称 | 描述 | 优先级 | 预估工期 |
|----|---------|------|-------|---------|
| WS-004 | 实时统计数据推送 | /stats 接口数据实时推送（访问统计、性能指标） | P1 | 2天 |
| WS-005 | 系统健康监控推送 | /system/health 健康状态实时推送，异常即时告警 | P1 | 2天 |
| WS-006 | 消息类型过滤 | 客户端可按需订阅特定类型数据（status/stats/health） | P1 | 1天 |

### P2 - 增强功能（可选）

| ID | 功能名称 | 描述 | 优先级 | 预估工期 |
|----|---------|------|-------|---------|
| WS-007 | 连接数限制与队列 | 单用户最多 3 个并发连接，超限进入队列等待 | P2 | 1天 |
| WS-008 | 历史数据同步 | 首次连接时推送最近 N 条历史数据 | P2 | 2天 |
| WS-009 | 连接状态可视化 | 前端显示连接状态指示器（在线/离线/重连中） | P2 | 1天 |

---

## 3. 用户故事 (User Stories)

### 用户故事 1: 运营监控人员实时查看系统状态

```
作为 数字生命进化座舱的运营监控人员
我想要 在浏览器中实时看到系统状态变化，无需手动刷新页面
以便 及时发现系统异常并快速响应，降低故障处理时间
```

**业务价值**: 
- 减少平均故障发现时间 (MTTD) 从分钟级降至秒级
- 提升运维响应效率约 70%

**验收标准**:
- [ ] 系统状态变化在 100ms 内自动显示在仪表盘上
- [ ] 无需用户手动刷新页面即可看到最新数据
- [ ] 断网恢复后自动重连并同步最新数据

---

### 用户故事 2: 开发人员进行实时性能监控

```
作为 后台开发工程师
我想要 实时看到系统性能指标（CPU、内存、请求量）的变化趋势
以便 快速定位性能瓶颈并进行优化
```

**业务价值**:
- 实时性能监控支持更快的调优决策
- 减少因性能问题导致的用户体验下降

**验收标准**:
- [ ] 性能指标每秒自动更新，延迟不超过 500ms
- [ ] 图表平滑过渡，无闪烁或抖动
- [ ] 支持同时监控多个指标而不卡顿

---

### 用户故事 3: 管理员接收即时系统告警

```
作为 系统管理员
我想要 当系统健康状态异常时立即收到通知
以便 在问题恶化前采取预防措施
```

**业务价值**:
- 从被动响应转为主动预防
- 减少系统宕机时间，提升 SLA 达标率

**验收标准**:
- [ ] 系统异常时，告警信息在 1 秒内推送到客户端
- [ ] 告警信息包含异常类型、严重级别、时间戳
- [ ] 支持告警去重，相同问题不重复推送

---

### 用户故事 4: 用户按需订阅数据类型

```
作为 仪表盘用户
我想要 只订阅我关心的数据类型，屏蔽不相关的信息
以便 减少网络流量消耗并专注于重要指标
```

**业务价值**:
- 优化带宽使用，降低运营成本
- 提升用户专注度和工作效率

**验收标准**:
- [ ] 用户可选择订阅 status/stats/health 中的一种或多种
- [ ] 未订阅的数据类型不推送到客户端
- [ ] 订阅偏好可动态修改，无需重新连接

---

## 4. 验收标准 (Acceptance Criteria)

### 4.1 功能性标准（可黑盒测试验证）

| 标准 ID | 测试场景 | 测试步骤 | 预期结果 | 通过标准 |
|--------|---------|---------|---------|---------|
| AC-001 | WebSocket 连接建立 | 1. 打开仪表盘页面<br>2. 检查网络面板 | 显示 WebSocket 连接成功 (101 Switching Protocols) | 连接状态码 101 |
| AC-002 | 实时数据推送 | 1. 建立连接<br>2. 触发后端状态变更<br>3. 观察前端数据 | 前端在 100ms 内自动更新显示最新数据 | 延迟 ≤ 100ms |
| AC-003 | 心跳保活机制 | 1. 建立连接<br>2. 等待 30 秒<br>3. 查看网络面板 | 客户端每 30 秒发送 ping，服务器返回 pong | 心跳包间隔 30s |
| AC-004 | 断线自动重连 | 1. 建立连接<br>2. 断开网络 5 秒<br>3. 恢复网络 | 客户端自动重连，恢复后数据正常更新 | 重连时间 ≤ 3s |
| AC-005 | 消息类型过滤 | 1. 仅订阅 "status" 类型<br>2. 观察接收消息 | 只接收 status 相关消息，stats/health 消息不接收 | 消息过滤准确率 100% |
| AC-006 | 并发连接限制 | 1. 同一用户打开 4 个标签页<br>2. 观察第 4 个连接 | 前 3 个连接成功，第 4 个进入队列或拒绝 | 最大并发 3 个连接 |
| AC-007 | 系统告警推送 | 1. 模拟系统异常<br>2. 观察告警消息 | 告警消息在 1 秒内推送到所有已连接客户端 | 告警延迟 ≤ 1s |
| AC-008 | 历史数据同步 | 1. 新客户端建立连接<br>2. 查看初始推送消息 | 收到最近 50 条历史数据快照 | 历史数据条数 ≥ 50 |

### 4.2 非功能性标准

| 类别 | 指标 | 目标值 | 测试方法 |
|-----|------|-------|---------|
| **性能** | 消息推送延迟 | P95 < 100ms | 压力测试工具测量 |
| **性能** | 并发连接数 | 支持 1000+ 并发 | 使用 Artillery 压测 |
| **性能** | 内存占用 | 单连接 < 1MB | 监控 Bun 进程内存 |
| **可靠性** | 服务可用性 | 99.9% | 7x24 监控 |
| **兼容性** | 浏览器支持 | Chrome/Edge/Firefox/Safari 最新 2 个版本 | 跨浏览器测试 |

---

## 5. 技术风险分析

### 5.1 已识别风险

| 风险 ID | 风险描述 | 可能性 | 影响程度 | 缓解措施 | 负责人 |
|--------|---------|-------|---------|---------|-------|
| R-001 | **WebSocket 连接不稳定**<br>网络波动导致频繁断连 | 中 | 高 | 1. 实现指数退避重连策略<br>2. 添加连接状态可视化<br>3. 支持 fallback 到 SSE | 后端工程师 |
| R-002 | **服务端内存泄漏**<br>连接未正确关闭导致内存累积 | 中 | 高 | 1. 严格管理连接生命周期<br>2. 定期内存监控和报警<br>3. 连接超时强制回收 | 后端工程师 |
| R-003 | **SQLite 并发瓶颈**<br>高频写入导致数据库锁竞争 | 中 | 中 | 1. 引入消息队列削峰<br>2. 批量写入优化<br>3. 考虑 WAL 模式优化 | 后端工程师 |
| R-004 | **客户端性能问题**<br>高频消息更新导致 UI 卡顿 | 低 | 中 | 1. 使用 requestAnimationFrame 节流<br>2. 虚拟滚动优化<br>3. Web Worker 处理数据 | 前端工程师 |
| R-005 | **Bun 运行时兼容性**<br>Elysia WebSocket API 可能存在边缘 case | 低 | 中 | 1. 充分测试覆盖<br>2. 关注 Bun 更新日志<br>3. 准备降级方案 (Node.js) | 架构师 |
| R-006 | **Nginx 反向代理配置**<br>WebSocket 升级头可能转发失败 | 中 | 高 | 1. 正确配置 upgrade 和 connection 头<br>2. 增加 proxy_read_timeout<br>3. 测试验证配置 | 运维工程师 |

### 5.2 风险评估矩阵

```
影响程度
    高 │ R-001  R-006
       │ R-002
    中 │ R-003  R-004
       │        R-005
    低 │
       └──────────────────────
         低      中      高    可能性
```

---

## 6. 依赖项清单

### 6.1 技术依赖

| 依赖项 | 版本要求 | 用途 | 安装命令 | 状态 |
|-------|---------|------|---------|------|
| Bun | ≥ 1.1.0 | 运行时和包管理 | `curl -fsSL https://bun.sh/install` | 🔲 待确认 |
| Elysia | ≥ 1.0.0 | Web 框架和 WebSocket 支持 | `bun add elysia` | 🔲 待确认 |
| @elysiajs/websocket | 最新版 | WebSocket 插件 | `bun add @elysiajs/websocket` | 🔲 待确认 |
| React | ≥ 18.0.0 | 前端框架 | 已存在 | ✅ 已具备 |
| TypeScript | ≥ 5.0 | 类型安全 | 已存在 | ✅ 已具备 |
| SQLite3 | ≥ 5.0 | 数据存储 | 已存在 | ✅ 已具备 |

### 6.2 基础设施依赖

| 依赖项 | 描述 | 负责人 | 截止日期 | 状态 |
|-------|------|-------|---------|------|
| Nginx 配置更新 | 支持 WebSocket 代理转发 | 运维 | Sprint 1 Day 3 | 🔲 待完成 |
| SSL 证书 | 确保 wss:// 连接可用 | 运维 | Sprint 1 Day 1 | ✅ 已具备 |
| 服务器资源 | 评估并发连接所需的内存/CPU | 运维 | Sprint 1 Day 1 | 🔲 待评估 |
| 监控告警 | WebSocket 连接数监控 | 运维 | Sprint 1 Day 5 | 🔲 待完成 |

### 6.3 外部依赖

| 依赖项 | 描述 | 风险等级 | 备选方案 |
|-------|------|---------|---------|
| Bun 稳定性 | Bun 相对较新，WebSocket 实现需验证 | 中 | 降级到 Node.js + ws 库 |
| 浏览器兼容性 | 旧版浏览器可能不支持 WebSocket | 低 | 提供降级提示页面 |
| 网络环境 | 某些企业防火墙可能阻止 WebSocket | 中 | 支持 SSE 降级方案 |

### 6.4 前置任务依赖图

```
[Sprint 1 任务依赖关系]

Day 1-2: WS-001 (基础连接)
    │
    ├─→ Day 3-4: WS-002 (状态推送)
    │       │
    │       ├─→ Day 5: WS-003 (心跳机制)
    │       │
    │       └─→ Day 5-6: WS-004 (统计推送)
    │
    └─→ Day 5-6: Nginx 配置更新
            │
            └─→ Day 7: 集成测试
```

---

## 7. 附录

### 7.1 术语表

| 术语 | 定义 |
|-----|------|
| WebSocket | 基于 TCP 的全双工通信协议，支持服务器主动推送 |
| Polling | 轮询，客户端定期请求服务器获取数据 |
| Heartbeat | 心跳，定期发送保活消息维持连接 |
| MTTD | Mean Time To Detect，平均故障发现时间 |
| SLA | Service Level Agreement，服务等级协议 |
| SSE | Server-Sent Events，服务器发送事件（单向推送） |
| WSS | WebSocket Secure，加密的 WebSocket 连接 |

### 7.2 参考资料

1. [Elysia WebSocket 文档](https://elysiajs.com/plugins/websocket.html)
2. [Bun WebSocket API](https://bun.sh/docs/api/websockets)
3. [React 使用 WebSocket 最佳实践](https://react.dev/reference/react/useSyncExternalStore)
4. [WebSocket vs Polling 性能对比](https://blog.example.com/websocket-performance)

### 7.3 变更历史

| 版本 | 日期 | 变更内容 | 作者 |
|-----|------|---------|------|
| 1.0 | 2026-02-03 | 初始版本，完成 Sprint 1 需求分析 | 产品经理 |

---

**文档状态**: 🟡 评审中

**下一步行动**:
1. 技术总监评审 PRD 并批准
2. 架构师评估技术依赖和可行性
3. 进入 Sprint 1 开发阶段

**审批签名**:
- [ ] 技术总监: _________________ 日期: _______
- [ ] 架构师: _________________ 日期: _______
